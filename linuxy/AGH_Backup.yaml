---
# --- ETAP 1: BACKUP Z SERWERA PRODUKCYJNEGO AGH ---
- name: Kopia zapasowa AdGuard Home z serwera AGH
  hosts: agh
  become: yes
  gather_facts: yes

  vars:
    backup_storage: "/tmp/backups_agh"
    agh_path: "/adguardhome"

  tasks:
    - name: "Blok operacyjny - Backup"
      block:
        - name: Pakujƒô folder AdGuarda (RAID1)
          archive:
            path: "{{ agh_path }}"
            dest: "/tmp/agh_backup.tar.gz"
            format: gz

        - name: Pobieram backup na serwer Ansible (Semaphore)
          fetch:
            src: "/tmp/agh_backup.tar.gz"
            dest: "{{ backup_storage }}/latest_backup.tar.gz"
            flat: yes
      
      rescue:
        - name: ALERT DISCORD - B≈ÇƒÖd Backup
          community.general.discord:
            webhook_id: "1450900992336859249"
            webhook_token: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              37303932373334626461343363663132666666633464626634386438613066653963643364343535
              3137616262333132366631653336616136663835326232300a663636323263616238316434623663
              37373232396461643230366264323465326264636534383361393136393561613834323162343637
              6436323463366338620a643631323964656635643166353535643830653866373037663465323964
              65633865366334326136363932643966623233633366343930643339383136656332666463616432
              30613830376133386563633438356531653339356566643333366233356530383935623465303539
              37323133356365626338303062386436383130333837376130356661343762363733393365343838
              36386532613435626466
            username: Semaphore
            content: "üö® **B≈ÅƒÑD BACKUPU!** Co≈õ pad≈Ço przy pakowaniu na serwerze AGH."

# --- ETAP 2: ODTWORZENIE I URUCHOMIENIE NA SERWERZE ANSIBLE (localhost) ---
- name: Weryfikacja backupu i uruchomienie testowe
  hosts: localhost
  connection: local
  gather_facts: no  # <--- WY≈ÅƒÑCZONE, ≈ºeby nie szuka≈Ço sudo
  become: no        # <--- WY≈ÅƒÑCZONE, dzia≈Çamy jako zwyk≈Çy u≈ºytkownik Semaphore

  vars:
    backup_storage: "/tmp/backups_agh"
    test_restore_path: "/tmp/test_recovery_agh"

  tasks:
    - name: "Blok operacyjny - Uruchomienie Testowe"
      block:
        - name: Przygotowujƒô czysty folder testowy
          file:
            path: "{{ test_restore_path }}"
            state: "{{ item }}"
          loop: [absent, directory]

        - name: Rozpakowujƒô backup na localhost
          unarchive:
            src: "{{ backup_storage }}/latest_backup.tar.gz"
            dest: "{{ test_restore_path }}"
            remote_src: yes
            extra_opts: ['--strip-components=1']

        - name: Zamykam stary proces testowy (je≈õli dzia≈Ça≈Ç)
          shell: "pkill -f AdGuardHome || true"

        - name: Nadajƒô uprawnienia binarce
          file:
            path: "{{ test_restore_path }}/AdGuardHome"
            mode: '0755'

        - name: URUCHAMIAM ADGUARDA W TLE NA PORCIE 8888
          shell: "nohup ./AdGuardHome -p 8888 > /dev/null 2>&1 &"
          args:
            chdir: "{{ test_restore_path }}"
          async: 10
          poll: 0

      rescue:
        - name: ALERT DISCORD - B≈ÇƒÖd Weryfikacji
          community.general.discord:
            webhook_id: "1450900992336859249"
            webhook_token: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              37303932373334626461343363663132666666633464626634386438613066653963643364343535
              3137616262333132366631653336616136663835326232300a663636323263616238316434623663
              37373232396461643230366264323465326264636534383361393136393561613834323162343637
              6436323463366338620a643631323964656635643166353535643830653866373037663465323964
              65633865366334326136363932643966623233633366343930643339383136656332666463616432
              30613830376133386563633438356531653339356566643333366233356530383935623465303539
              37323133356365626338303062386436383130333837376130356661343762363733393365343838
              36386532613435626466
            username: Semaphore
            content: "üö® **B≈ÅƒÑD WERYFIKACJI!** Nie uda≈Ço siƒô odpaliƒá AdGuarda na serwerze Ansible."
